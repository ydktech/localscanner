<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Ultra Search - Ï†àÎåÄ ÎÜìÏπòÏßÄ ÏïäÎäî Í≤ÄÏÉâÍ∏∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .search-section {
            padding: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .search-form {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            border-color: #667eea;
        }

        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
        }

        .settings {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .settings input,
        .settings select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .keywords-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .keyword-group {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .keyword-group h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .keyword-item {
            background: white;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #eee;
        }

        .map-container {
            margin: 30px;
        }

        #map {
            width: 100%;
            height: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .results-section {
            margin: 30px;
        }

        .result-item {
            background: #f9f9f9;
            padding: 20px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .result-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .result-rating {
            background: #ffb400;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
        }

        .result-details {
            color: #666;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .stats {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .cost-info {
            background: #fff3e0;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #ff9800;
        }

        .cost-info h4 {
            margin: 0 0 10px 0;
            color: #e65100;
        }

        .timing-info {
            background: #f3e5f5;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #9c27b0;
        }

        .timing-info h4 {
            margin: 0 0 10px 0;
            color: #6a1b9a;
        }

        .timing-step {
            background: white;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #e1bee7;
            font-size: 14px;
        }

        .timing-step strong {
            color: #7b1fa2;
        }

        .loading-indicator {
            background: #e1f5fe;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #03a9f4;
            text-align: center;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #03a9f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .progress-step {
            background: #f0f4f8;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #2196f3;
        }

        .progress-step.active {
            background: #e3f2fd;
            border-left: 3px solid #1976d2;
            animation: pulse 2s infinite;
        }

        .progress-step.completed {
            background: #e8f5e8;
            border-left: 3px solid #4caf50;
        }

        @keyframes pulse {
            0% {
                background: #e3f2fd;
            }

            50% {
                background: #bbdefb;
            }

            100% {
                background: #e3f2fd;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Ultra Search</h1>
            <p>Ï†àÎåÄ ÎÜìÏπòÏßÄ ÏïäÎäî Í≤ÄÏÉâÍ∏∞</p>
        </div>

        <div class="search-section">
            <div class="search-form">
                <input type="text" id="koreanInput" class="search-input"
                    placeholder="ÌïúÍµ≠Ïñ¥Î°ú Ï∞æÍ≥† Ïã∂ÏùÄ Í≥≥ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: Ï†êÏã¨Î∞•, ÎßõÏûàÎäî ÏãùÎãπ, Î∏åÎü∞Ïπò Ïπ¥Ìéò)">
                <button onclick="search()" class="search-btn">üîç Í≤ÄÏÉâ</button>
            </div>


            <div id="keywordsSection" class="keywords-section" style="display: none;">
                <div class="keyword-group">
                    <h3>üéØ ÏßÅÏ†ë Î≤àÏó≠</h3>
                    <div id="directTranslations"></div>
                </div>
                <div class="keyword-group">
                    <h3>üîÑ Ï∂îÏÉÅÏ†Å Î≤àÏó≠</h3>
                    <div id="abstractTranslations"></div>
                </div>

            </div>

            <div id="messageArea"></div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>

        <div class="results-section">
            <div id="resultsArea"></div>
        </div>
    </div>

    <script>
        let map;
        let markers = [];
        let apiKey = '';
        let userLocation = null;

        // Get API key
        fetch('/api/key')
            .then(response => response.json())
            .then(data => {
                apiKey = data.api_key;
            })
            .catch(error => console.error('Error getting API key:', error));

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: { lat: 35.6762, lng: 139.6503 }, // Tokyo
                styles: [
                    {
                        "featureType": "all",
                        "elementType": "geometry.fill",
                        "stylers": [{ "weight": "2.00" }]
                    },
                    {
                        "featureType": "all",
                        "elementType": "geometry.stroke",
                        "stylers": [{ "color": "#9c9c9c" }]
                    },
                    {
                        "featureType": "all",
                        "elementType": "labels.text",
                        "stylers": [{ "visibility": "on" }]
                    }
                ]
            });

            // Show initial GPS status and get current location
            showMessage('üîÑ GPS ÏúÑÏπòÎ•º ÌôïÏù∏ Ï§ëÏûÖÎãàÎã§...', 'info');
            getCurrentLocationAuto();
        }

        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }

        function addMarker(place) {
            const marker = new google.maps.Marker({
                position: { lat: place.lat, lng: place.lng },
                map: map,
                title: place.name,
                icon: {
                    url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });

            let distanceText = '';
            if (userLocation) {
                const distance = calculateDistance(userLocation.lat, userLocation.lng, place.lat, place.lng);
                distanceText = `<p><strong>Í±∞Î¶¨:</strong> ${distance.toFixed(1)}km</p>`;
            }

            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="max-width: 300px;">
                        <h3>${place.name}</h3>
                        <p><strong>ÌèâÏ†ê:</strong> ${place.rating}‚≠ê</p>
                        <p><strong>Ï£ºÏÜå:</strong> ${place.address}</p>
                        ${distanceText}
                        <p><strong>Í≤ÄÏÉâÏñ¥:</strong> ${place.search_term}</p>
                        <p><strong>ÌÉÄÏûÖ:</strong> ${place.search_type}</p>
                    </div>
                `
            });

            marker.addListener('click', () => {
                infoWindow.open(map, marker);
            });

            markers.push(marker);
        }

        function addUserLocationMarker() {
            if (userLocation) {
                const userMarker = new google.maps.Marker({
                    position: { lat: userLocation.lat, lng: userLocation.lng },
                    map: map,
                    title: "ÎÇ¥ ÏúÑÏπò",
                    icon: {
                        url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                        scaledSize: new google.maps.Size(50, 50)
                    }
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: '<div><h3>üìç ÎÇ¥ ÏúÑÏπò</h3></div>'
                });

                userMarker.addListener('click', () => {
                    infoWindow.open(map, userMarker);
                });

                markers.push(userMarker);
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function getCurrentLocationAuto() {
            if (navigator.geolocation) {
                console.log('Getting current location automatically...');

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Location coordinates stored in userLocation variable

                        // Center map on user location
                        map.setCenter(userLocation);
                        map.setZoom(15);

                        // Add user location marker
                        addUserLocationMarker();

                        console.log('Current location set successfully');
                        showMessage(`üìç GPS ÏúÑÏπò ÌôïÏù∏Îê®: ${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`, 'success');
                    },
                    (error) => {
                        console.error('GPS ÏúÑÏπò Ïò§Î•ò:', error.message);
                        showMessage('‚ö†Ô∏è ÏúÑÏπò Ï†ëÍ∑º Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§. Ï†ïÌôïÌïú Í≤ÄÏÉâÏùÑ ÏúÑÌï¥ Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÏúÑÏπò Í∂åÌïúÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                        // Silently fail and keep default Tokyo location
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    }
                );
            } else {
                console.log('Geolocation not supported, using default Tokyo location');
            }
        }

        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function showLoadingIndicator() {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `
                <div class="loading-indicator">
                    <div class="loading-spinner"></div>
                    <strong>üîç Ultra Search Ïã§Ìñâ Ï§ë...</strong>
                </div>
                <div id="progressSteps">
                    <div class="progress-step active" id="step1">‚è≥ AI ÌÇ§ÏõåÎìú ÏÉùÏÑ± Ï§ë...</div>
                    <div class="progress-step" id="step2">‚è≥ Ï∂îÏÉÅ Î≤àÏó≠ Í≤ÄÏÉâ ÎåÄÍ∏∞ Ï§ë...</div>
                    <div class="progress-step" id="step3">‚è≥ Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ ÎåÄÍ∏∞ Ï§ë...</div>
                    <div class="progress-step" id="step4">‚è≥ Í≤∞Í≥º Ï†ïÎ¶¨ ÎåÄÍ∏∞ Ï§ë...</div>
                </div>
            `;
        }

        function updateProgress(stepNumber, message, completed = false) {
            const step = document.getElementById(`step${stepNumber}`);
            if (step) {
                step.innerHTML = message;
                step.classList.remove('active');
                if (completed) {
                    step.classList.add('completed');
                } else {
                    step.classList.add('active');
                }
            }

            // Activate next step if current is completed
            if (completed && stepNumber < 4) {
                const nextStep = document.getElementById(`step${stepNumber + 1}`);
                if (nextStep && !nextStep.classList.contains('completed')) {
                    nextStep.classList.add('active');
                }
            }
        }

        function showKeywords(keywords) {
            document.getElementById('keywordsSection').style.display = 'grid';

            // Direct translations
            const directDiv = document.getElementById('directTranslations');
            directDiv.innerHTML = '';
            keywords.direct_translation.forEach(keyword => {
                directDiv.innerHTML += `<div class="keyword-item">${keyword}</div>`;
            });

            // Abstract translations
            const abstractDiv = document.getElementById('abstractTranslations');
            abstractDiv.innerHTML = '';
            keywords.abstract_translation.forEach(keyword => {
                abstractDiv.innerHTML += `<div class="keyword-item">${keyword}</div>`;
            });


        }

        function showCostInfo(keywords) {
            const messageArea = document.getElementById('messageArea');

            if (keywords.api_calls && keywords.estimated_cost_usd) {
                const costHtml = `
                    <div class="cost-info">
                        <h4>üí∞ API ÏÇ¨Ïö©Îüâ Î∞è ÎπÑÏö©</h4>
                        <p><strong>Í≤ÄÏÉâ Ï†ÑÎûµ:</strong> ${keywords.search_strategy || 'Progressive Radius Search'}</p>
                        <p><strong>API Ìò∏Ï∂ú Ïàò:</strong> ${keywords.api_calls}Ìöå</p>
                        <p><strong>ÏòàÏÉÅ ÎπÑÏö©:</strong> $${keywords.estimated_cost_usd} (ÏïΩ ${keywords.estimated_cost_krw}Ïõê)</p>
                        <p><small>* Ï†êÏßÑÏ†Å Î∞òÍ≤Ω Í≤ÄÏÉâÏúºÎ°ú Í∞ÄÏû• Í∞ÄÍπåÏö¥ Ïû•ÏÜå Ïö∞ÏÑ† ÌÉêÏÉâ</small></p>
                    </div>
                `;
                messageArea.innerHTML += costHtml;
            }
        }

        function showTimingInfo(keywords) {
            const messageArea = document.getElementById('messageArea');

            // Show LLM timing from ultra_search.py
            if (keywords.timing) {
                let timingHtml = `
                    <div class="timing-info">
                        <h4>‚è±Ô∏è LLM ÌÇ§ÏõåÎìú ÏÉùÏÑ± ÏãúÍ∞Ñ</h4>
                        <div class="timing-step"><strong>Vertex AI Ï¥àÍ∏∞Ìôî:</strong> ${keywords.timing.vertex_init_time}Ï¥à</div>
                        <div class="timing-step"><strong>LLM ÌÇ§ÏõåÎìú ÏÉùÏÑ±:</strong> ${keywords.timing.llm_generation_time}Ï¥à</div>
                        <div class="timing-step"><strong>Ï†ÑÏ≤¥ ÌÇ§ÏõåÎìú ÏÉùÏÑ±:</strong> ${keywords.timing.total_time}Ï¥à</div>
                    </div>
                `;
                messageArea.innerHTML += timingHtml;
            }

            // Show search timing from flask_app.py
            if (keywords.search_timing) {
                let searchTimingHtml = `
                    <div class="timing-info">
                        <h4>üîç Í≤ÄÏÉâ Ïã§Ìñâ ÏãúÍ∞Ñ</h4>
                        <div class="timing-step"><strong>ÌÇ§ÏõåÎìú ÏÉùÏÑ±:</strong> ${keywords.search_timing.keyword_generation_time}Ï¥à</div>
                        <div class="timing-step"><strong>Ï∂îÏÉÅ Î≤àÏó≠ Í≤ÄÏÉâ:</strong> ${keywords.search_timing.abstract_search_time}Ï¥à</div>
                        <div class="timing-step"><strong>Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ:</strong> ${keywords.search_timing.category_search_time}Ï¥à</div>
                        <div class="timing-step"><strong>API Í≤ÄÏÉâ Ï¥ù ÏãúÍ∞Ñ:</strong> ${keywords.search_timing.api_search_time}Ï¥à</div>
                        <div class="timing-step"><strong>Ï†ÑÏ≤¥ Í≤ÄÏÉâ ÏãúÍ∞Ñ:</strong> ${keywords.search_timing.total_search_time}Ï¥à</div>
                    </div>
                `;
                messageArea.innerHTML += searchTimingHtml;
            }
        }

        function showResults(places) {
            const resultsArea = document.getElementById('resultsArea');

            if (places.length === 0) {
                resultsArea.innerHTML = '<div class="error">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }

            // Sort by distance if user location is available
            if (userLocation) {
                places.forEach(place => {
                    place.distance = calculateDistance(userLocation.lat, userLocation.lng, place.lat, place.lng);
                });
                places.sort((a, b) => a.distance - b.distance);
            }

            let html = `<div class="stats">Ï¥ù ${places.length}Í∞úÏùò Ïû•ÏÜåÎ•º Ï∞æÏïòÏäµÎãàÎã§!</div>`;

            // Show detailed search timing for first result (they all have same timing)
            if (places.length > 0 && places[0].search_timings) {
                html += `
                    <div class="timing-info">
                        <h4>üìä Ï†êÏßÑÏ†Å Î∞òÍ≤Ω Í≤ÄÏÉâ ÏÉÅÏÑ∏</h4>
                        <div class="timing-step"><strong>Ï†ÑÏ≤¥ Í≤ÄÏÉâ ÏãúÍ∞Ñ:</strong> ${places[0].total_search_time}Ï¥à</div>
                `;

                places[0].search_timings.forEach(timing => {
                    html += `
                        <div class="timing-step">
                            <strong>${timing.radius}m Î∞òÍ≤Ω:</strong> 
                            API ${timing.api_time}Ï¥à, Ï≤òÎ¶¨ ${timing.processing_time}Ï¥à 
                            (ÏÉà Í≤∞Í≥º ${timing.new_results}Í∞ú, ÎàÑÏ†Å ${timing.total_results}Í∞ú)
                        </div>
                    `;
                });

                html += `</div>`;
            }

            places.forEach(place => {
                let distanceText = '';
                if (userLocation && place.distance) {
                    distanceText = `<p><strong>Í±∞Î¶¨:</strong> ${place.distance.toFixed(1)}km</p>`;
                }

                html += `
                    <div class="result-item">
                        <div class="result-header">
                            <div class="result-name">${place.name}</div>
                            <div class="result-rating">${place.rating}‚≠ê</div>
                        </div>
                        <div class="result-details">
                            <p><strong>Ï£ºÏÜå:</strong> ${place.address}</p>
                            ${distanceText}
                            <p><strong>Í≤ÄÏÉâÏñ¥:</strong> ${place.search_term}</p>
                            <p><strong>ÌÉÄÏûÖ:</strong> ${place.search_type}</p>
                            <p><strong>Ïπ¥ÌÖåÍ≥†Î¶¨:</strong> ${place.types.join(', ')}</p>
                        </div>
                    </div>
                `;
            });

            resultsArea.innerHTML = html;
        }

        function search() {
            const koreanText = document.getElementById('koreanInput').value;

            if (!koreanText) {
                showMessage('ÌïúÍµ≠Ïñ¥ Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            // GPS ÏóÜÏúºÎ©¥ Í∑∏ÎÉ• ÏóêÎü¨
            if (!userLocation) {
                showMessage('‚ùå GPS ÏúÑÏπòÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§. Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú ÏúÑÏπò Ï†ëÍ∑ºÏùÑ ÌóàÏö©ÌïòÍ≥† ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏÑ∏Ïöî.', 'error');
                return;
            }

            const location = `${userLocation.lat},${userLocation.lng}`;
            const radius = 500; // üéØ Î∞±ÏóîÎìú SEARCH_RADIUSÏôÄ ÎèôÏùºÌïòÍ≤å Ïú†ÏßÄ

            console.log(`[GPS] ÌòÑÏû¨ ÏúÑÏπòÏóêÏÑú Í≤ÄÏÉâ: ${userLocation.lat}, ${userLocation.lng}`);
            showMessage(`üéØ ÌòÑÏû¨ ÏúÑÏπòÏóêÏÑú ${radius}m Î∞òÍ≤Ω Í≤ÄÏÉâ Ï§ë...`, 'info');

            // Show loading indicator with progress steps
            showLoadingIndicator();
            clearMarkers();

            // Start search with progress tracking
            const startTime = Date.now();

            fetch('/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    korean_text: koreanText,
                    location: location,
                    radius: radius
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showMessage(data.error, 'error');
                        return;
                    }

                    // Update final progress
                    updateProgress(4, '‚úÖ Í≤ÄÏÉâ ÏôÑÎ£å!', true);

                    const totalTime = (Date.now() - startTime) / 1000;
                    setTimeout(() => {
                        showMessage(`‚úÖ Í≤ÄÏÉâ ÏôÑÎ£å! ${data.total_results}Í∞úÏùò Ïû•ÏÜåÎ•º Ï∞æÏïòÏäµÎãàÎã§. (Ï¥ù ${totalTime.toFixed(1)}Ï¥à)`, 'success');

                        // Show keywords
                        showKeywords(data.keywords);

                        // Show cost information
                        showCostInfo(data.keywords);

                        // Show timing information
                        showTimingInfo(data.keywords);

                        // Show results
                        showResults(data.places);
                    }, 500);

                    // Add markers to map
                    if (data.places.length > 0) {
                        data.places.forEach(place => addMarker(place));

                        // Add user location marker if available
                        addUserLocationMarker();

                        // Center map appropriately
                        if (userLocation) {
                            map.setCenter(userLocation);
                            map.setZoom(14);
                        } else {
                            const firstPlace = data.places[0];
                            map.setCenter({ lat: firstPlace.lat, lng: firstPlace.lng });
                            map.setZoom(13);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('Í≤ÄÏÉâ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                });

            // Simulate progress updates (since we can't get real-time updates from Flask)
            setTimeout(() => updateProgress(1, '‚úÖ AI ÌÇ§ÏõåÎìú ÏÉùÏÑ± ÏôÑÎ£å', true), 1000);
            setTimeout(() => updateProgress(2, 'üîç Ï∂îÏÉÅ Î≤àÏó≠ Í≤ÄÏÉâ Ï§ë...', false), 1500);
            setTimeout(() => updateProgress(2, '‚úÖ Ï∂îÏÉÅ Î≤àÏó≠ Í≤ÄÏÉâ ÏôÑÎ£å', true), 3000);
            setTimeout(() => updateProgress(3, 'üîç Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ Ï§ë...', false), 3500);
            setTimeout(() => updateProgress(3, '‚úÖ Ïπ¥ÌÖåÍ≥†Î¶¨ Í≤ÄÏÉâ ÏôÑÎ£å', true), 5000);
            setTimeout(() => updateProgress(4, 'üìä Í≤∞Í≥º Ï†ïÎ¶¨ Ï§ë...', false), 5500);
        }

        // Enter key support
        document.getElementById('koreanInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                search();
            }
        });
    </script>

    <script>
        // Load Google Maps API dynamically
        fetch('/api/key')
            .then(response => response.json())
            .then(data => {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${data.api_key}&callback=initMap`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
            })
            .catch(error => console.error('Error loading Google Maps:', error));
    </script>
</body>

</html>